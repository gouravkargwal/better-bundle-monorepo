name: Scheduled Analysis
on:
  schedule:
    - cron: "0 */4 * * *" # Every 4 hours at minute 0

jobs:
  trigger-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Install Doppler CLI
        run: |
          curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh
          echo "$HOME/.doppler/bin" >> $GITHUB_PATH

      - name: Fetch Secrets from Doppler
        run: |
          echo "🔐 Fetching secrets from Doppler..."
          doppler secrets download --no-file --format=env --token=${{ secrets.DOPPLER_TOKEN }} > .env
          source .env

          echo "✅ Secrets loaded from Doppler"
          echo "📡 Vercel URL: $VERCEL_APP_URL"
          echo "🔑 Cron Secret: ${CRON_SECRET:0:10}..."

      - name: Trigger Analysis
        run: |
          echo "🕐 Triggering scheduled analysis check..."
          curl -X POST $VERCEL_APP_URL/api/cron/check-scheduled-analyses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CRON_SECRET" \
            --max-time 300 \
            --retry 3

          if [ $? -eq 0 ]; then
            echo "✅ Analysis check triggered successfully"
          else
            echo "❌ Failed to trigger analysis check"
            exit 1
          fi
