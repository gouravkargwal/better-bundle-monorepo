{% comment %}
  React Recommendation Base Snippet
  Usage: {% render 'recommendation-base', context: 'product_page', product_ids: [product.id] %}

  All logic now handled by React components (Carousel.tsx, ProductCard.tsx)
  This snippet just mounts the React app with proper props
{% endcomment %}

{% comment %} Auto-detect context based on page type {% endcomment %}
{% assign detected_context = context %}
{% if template.name == 'index' or template.name == 'page' %}
  {% assign detected_context = 'homepage' %}
{% elsif template.name == 'product' %}
  {% assign detected_context = 'product_page' %}
{% elsif template.name == 'collection' %}
  {% assign detected_context = 'collection_page' %}
{% elsif template.name == 'cart' %}
  {% assign detected_context = 'cart' %}
{% endif %}

{% comment %} Extract session ID from cart attributes {% endcomment %}
{% assign session_id = null %}
{% for attribute in cart.attributes %}
  {% if attribute.first == 'bb_recommendation_session_id' %}
    {% assign session_id = attribute.last %}
    {% break %}
  {% endif %}
{% endfor %}

{% comment %} Prepare product IDs based on context {% endcomment %}
{% assign context_product_ids = product_ids | default: '' %}
{% if detected_context == 'cart' %}
  {% assign context_product_ids = cart.items | map: 'product_id' | join: ',' %}
{% elsif detected_context == 'product_page' and product %}
  {% assign context_product_ids = product.id %}
{% endif %}

<div
  class="phoenix-extension"
  data-phoenix-component="product-carousel"
  data-phoenix-props='
    {
      "limit": {{ block.settings.limit | default: 6 }},
      "enable_autoplay": {{ block.settings.enable_autoplay | default: true }},
      "autoplay_delay": {{ block.settings.autoplay_delay | default: 2.5 | times: 1000 }},
      "show_arrows": {{ block.settings.show_arrows | default: true }},
      "show_pagination": {{ block.settings.show_pagination | default: true }},
      "context": "{{ detected_context }}",
      "product_ids": [{{ context_product_ids }}],
      "currency": "{{ shop.currency }}",
      "session_id": {{ session_id | json }}
    }
  '
  {% if detected_context == 'product_page' and product %}
    data-product-id="{{ product.id }}"
  {% endif %}
  {% if detected_context == 'collection_page' and collection %}
    data-collection-id="{{ collection.id }}"
  {% endif %}
  data-customer-id="{{ customer.id }}"
  data-shop-domain="{{ shop.permanent_domain }}"
>
  <div class="phoenix-loading">
    <p>Loading recommendationsâ€¦</p>
  </div>
</div>

{% render 'recommendation-styles' %}

<link rel="stylesheet" href="{{ 'phoenix.css' | asset_url }}">
<script src="{{ 'phoenix.js' | asset_url }}" defer></script>
